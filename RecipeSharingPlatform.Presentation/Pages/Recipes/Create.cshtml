@page
@model RecipeSharingPlatform.Presentation.Pages.Recipes.CreateModel
@{
    ViewData["Title"] = "Create Recipe";
}

<style>
    :root {
        --bg: #F6F7F9;
        --card: #FFFFFF;
        --text: #0F172A;
        --muted: #64748B;
        --line: #E2E8F0;
        --brand: #4F46E5;
        --brand2: #EC4899;
        --danger: #DC2626;
        --shadow: 0 10px 24px rgba(15,23,42,.06);
        --radius: 16px;
        --radius2: 22px;
    }

    body {
        background: var(--bg);
    }

    .cr-wrap {
        max-width: 1120px;
        margin: 0 auto;
        padding: 2rem 1.25rem 3rem;
        font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
        color: var(--text);
    }

    .cr-title {
        font-size: 1.8rem;
        font-weight: 850;
        letter-spacing: -0.02em;
        margin: 0 0 1rem 0;
    }

    .cr-card {
        background: var(--card);
        border-radius: var(--radius2);
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        padding: 1.5rem 1.6rem 1.6rem;
    }

    .cr-grid {
        display: grid;
        grid-template-columns: minmax(0,2.1fr) minmax(0,1.2fr);
        gap: 1.4rem;
        align-items: flex-start;
    }

    .cr-section-title {
        font-size: 1.1rem;
        font-weight: 800;
        margin: 0 0 .7rem 0;
    }

    .cr-field {
        margin-bottom: .8rem;
    }

    .cr-label {
        display: block;
        font-size: .9rem;
        font-weight: 650;
        margin-bottom: .25rem;
        color: #111827;
    }

    .cr-input, .cr-select, .cr-textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--line);
        padding: .55rem .7rem;
        font-size: .92rem;
        outline: none;
        background: #F9FAFB;
    }

        .cr-input:focus, .cr-select:focus, .cr-textarea:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 1px rgba(79,70,229,.28);
            background: #fff;
        }

    .cr-textarea {
        resize: vertical;
        min-height: 90px;
    }

    .cr-row {
        display: flex;
        gap: .7rem;
    }

        .cr-row > .cr-field {
            flex: 1;
        }

    .cr-checkbox-row {
        display: flex;
        align-items: center;
        gap: .45rem;
        margin-top: .35rem;
        font-size: .9rem;
        color: var(--muted);
    }

    .cr-checkbox {
        width: 18px;
        height: 18px;
    }

    /* Upload card */
    .cr-upload-card {
        border-radius: var(--radius);
        border: 1px dashed var(--line);
        padding: .9rem .9rem 1rem;
        background: #F9FAFB;
    }

    .cr-upload-zone {
        border-radius: 14px;
        border: 1px dashed #CBD5E1;
        padding: 1rem .9rem;
        text-align: center;
        background: #FFF;
        cursor: pointer;
    }

        .cr-upload-zone:hover {
            border-color: var(--brand);
            background: #EEF2FF;
        }

        .cr-upload-zone span {
            display: block;
            font-size: .88rem;
            color: var(--muted);
        }

    .cr-upload-input {
        display: none;
    }

    .cr-preview {
        margin-top: .7rem;
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
    }

    .cr-preview-item {
        position: relative;
        width: 90px;
        height: 70px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--line);
        background: #CBD5E1;
    }

        .cr-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .cr-preview-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: none;
        background: rgba(15,23,42,.85);
        color: #fff;
        font-size: 11px;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

        .cr-preview-remove:hover {
            background: rgba(220,38,38,.92);
        }


    /* Ingredients + Steps */
    .cr-tagline {
        font-size: .86rem;
        color: var(--muted);
        margin-bottom: .4rem;
    }

    .cr-ing-rows, .cr-step-rows {
        display: flex;
        flex-direction: column;
        gap: .4rem;
    }

    .cr-ing-row, .cr-step-row {
        display: flex;
        gap: .4rem;
        align-items: flex-start;
    }

        .cr-ing-row input,
        .cr-step-row textarea {
            font-size: .9rem;
        }

    .cr-ing-name {
        flex: 2;
    }

    .cr-ing-qty {
        flex: .9;
    }

    .cr-ing-unit {
        flex: 1;
    }

    .cr-step-text {
        flex: 1;
    }

    .cr-small-input {
        border-radius: 10px;
        border: 1px solid var(--line);
        padding: .45rem .6rem;
        background: #F9FAFB;
        width: 100%;
    }

    .cr-small-textarea {
        border-radius: 10px;
        border: 1px solid var(--line);
        padding: .5rem .6rem;
        background: #F9FAFB;
        width: 100%;
        min-height: 68px;
        resize: vertical;
    }

    .cr-remove-btn {
        border: none;
        background: #FEE2E2;
        color: var(--danger);
        border-radius: 999px;
        padding: .2rem .45rem;
        cursor: pointer;
        font-size: .8rem;
        flex-shrink: 0;
    }

        .cr-remove-btn:hover {
            background: #FECACA;
        }

    .cr-add-btn {
        margin-top: .5rem;
        border: none;
        background: #EEF2FF;
        color: var(--brand);
        font-size: .86rem;
        border-radius: 999px;
        padding: .32rem .8rem;
        cursor: pointer;
        font-weight: 650;
    }

        .cr-add-btn:hover {
            background: #E0E7FF;
        }

    /* Footer */
    .cr-footer {
        margin-top: 1.3rem;
        display: flex;
        justify-content: flex-end;
        gap: .6rem;
    }

    .cr-btn {
        border-radius: 999px;
        border: none;
        padding: .55rem 1.4rem;
        font-size: .9rem;
        cursor: pointer;
        font-weight: 650;
    }

    .cr-btn-cancel {
        background: #E5E7EB;
        color: #111827;
    }

    .cr-btn-primary {
        background: linear-gradient(135deg,var(--brand),var(--brand2));
        color: #fff;
        box-shadow: 0 10px 22px rgba(79,70,229,.35);
    }

        .cr-btn-primary:hover {
            filter: brightness(1.03);
        }

    @@media (max-width:960px) {
        .cr-grid {
            grid-template-columns: minmax(0,1fr);
        }
    }

    @@media (max-width:640px) {
        .cr-wrap {
            padding-inline: .8rem;
        }
    }
</style>

<div class="cr-wrap">
    <h1 class="cr-title">Create new recipe</h1>

    <div class="cr-card">
        <form method="post" enctype="multipart/form-data">
            <div class="cr-grid">
                <!-- LEFT: info, desc, ingredients, steps -->
                <div>
                    <div class="cr-section">
                        <h2 class="cr-section-title">Basic information</h2>

                        <div class="cr-field">
                            <label class="cr-label" asp-for="Title">Title</label>
                            <input class="cr-input" asp-for="Title" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="cr-row">
                            <div class="cr-field">
                                <label class="cr-label" asp-for="CategoryId">Category</label>
                                <select class="cr-select" asp-for="CategoryId" asp-items="Model.CategoryOptions">
                                    <option value="">-- Select category --</option>
                                </select>
                            </div>

                            <div class="cr-field">
                                <label class="cr-label" asp-for="Difficulty">Difficulty</label>
                                <select class="cr-select" asp-for="Difficulty">
                                    <option value="">-- Choose --</option>
                                    <option value="Easy">Easy</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Hard">Hard</option>
                                </select>
                            </div>
                        </div>

                        <div class="cr-row">
                            <div class="cr-field">
                                <label class="cr-label" asp-for="Servings">Servings</label>
                                <input class="cr-input" asp-for="Servings" type="number" min="1" />
                            </div>
                            <div class="cr-field">
                                <label class="cr-label" asp-for="PrepTime">Prep time (min)</label>
                                <input class="cr-input" asp-for="PrepTime" type="number" min="0" />
                            </div>
                            <div class="cr-field">
                                <label class="cr-label" asp-for="CookTime">Cook time (min)</label>
                                <input class="cr-input" asp-for="CookTime" type="number" min="0" />
                            </div>
                        </div>

                        <div class="cr-field">
                            <label class="cr-label" asp-for="Description">Description</label>
                            <textarea class="cr-textarea" asp-for="Description"></textarea>
                        </div>

                        <div class="cr-checkbox-row">
                            <input class="cr-checkbox" asp-for="IsPublic" />
                            <label asp-for="IsPublic">Public recipe</label>
                        </div>
                    </div>

                    <hr style="border:none;border-top:1px solid var(--line);margin:1.2rem 0;" />

                    <div class="cr-section">
                        <h2 class="cr-section-title">Ingredients</h2>
                        <p class="cr-tagline">Add each ingredient with quantity and unit.</p>

                        <div id="ingredientRows" class="cr-ing-rows"></div>

                        <button type="button" id="btnAddIngredient" class="cr-add-btn">
                            + Add ingredient
                        </button>
                    </div>

                    <hr style="border:none;border-top:1px solid var(--line);margin:1.2rem 0;" />

                    <div class="cr-section">
                        <h2 class="cr-section-title">Steps</h2>
                        <p class="cr-tagline">Write each step clearly. Step number sẽ được tự động đánh.</p>

                        <div id="stepRows" class="cr-step-rows"></div>

                        <button type="button" id="btnAddStep" class="cr-add-btn">
                            + Add step
                        </button>
                    </div>
                </div>

                <!-- RIGHT: image upload -->
                <div>
                    <h2 class="cr-section-title">Images</h2>

                    <div class="cr-upload-card">
                        <div id="uploadZone" class="cr-upload-zone">
                            <strong>Click to select images</strong>
                            <span>or drag &amp; drop (Cloudinary upload when you save)</span>
                        </div>
                        <input id="RecipeImagesInput" class="cr-upload-input" type="file" name="RecipeImages" multiple accept="image/*" />

                        <div id="imagePreview" class="cr-preview"></div>
                    </div>
                </div>
            </div>

            <div class="cr-footer">
                <a asp-page="/Recipes/Index" class="cr-btn cr-btn-cancel">Cancel</a>
                <button type="submit" class="cr-btn cr-btn-primary">Save recipe</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            // =========================
            // 1) IMAGE UPLOAD + PREVIEW + REMOVE
            // =========================
            var uploadZone = document.getElementById("uploadZone");
            var fileInput = document.getElementById("RecipeImagesInput");
            var preview = document.getElementById("imagePreview");
            var selectedFiles = [];

            function syncFileInput() {
                var dt = new DataTransfer();
                selectedFiles.forEach(function (file) {
                    dt.items.add(file);
                });
                fileInput.files = dt.files;
            }

            function addFiles(files) {
                if (!files) return;
                Array.from(files).forEach(function (file) {
                    if (file && file.type && file.type.startsWith("image/")) {
                        selectedFiles.push(file);
                }
                });
                syncFileInput();
                renderPreviews();
            }

            function renderPreviews() {
                preview.innerHTML = "";
                if (!selectedFiles || selectedFiles.length === 0) {
                    return;
                }

                selectedFiles.forEach(function (file, index) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var wrapper = document.createElement("div");
                        wrapper.className = "cr-preview-item";
                        wrapper.setAttribute("data-index", index.toString());

                        wrapper.innerHTML =
                            '<button type="button" class="cr-preview-remove">✕</button>' +
                            '<img src="' + e.target.result + '" alt="preview" />';

                        preview.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            }

            uploadZone.addEventListener("click", function () {
                fileInput.click();
            });

            uploadZone.addEventListener("dragover", function (e) {
                e.preventDefault();
            });

            uploadZone.addEventListener("drop", function (e) {
                e.preventDefault();
                if (e.dataTransfer && e.dataTransfer.files) {
                    addFiles(e.dataTransfer.files);
                }
            });

            fileInput.addEventListener("change", function () {
                if (fileInput.files && fileInput.files.length > 0) {
                    // Nếu muốn mỗi lần chọn sẽ cộng dồn file mới vào:
                    addFiles(fileInput.files);

                    // Nếu bạn muốn chọn lại là reset toàn bộ:
                    // selectedFiles = Array.from(fileInput.files);
                    // syncFileInput();
                    // renderPreviews();
                }
            });

            preview.addEventListener("click", function (e) {
                if (e.target.classList.contains("cr-preview-remove")) {
                    var wrapper = e.target.closest(".cr-preview-item");
                    if (!wrapper) return;

                    var indexStr = wrapper.getAttribute("data-index");
                    var index = parseInt(indexStr);
                    if (isNaN(index)) return;

                    selectedFiles.splice(index, 1);
                    syncFileInput();
                    renderPreviews();
                }
            });

            // =========================
            // 2) DYNAMIC INGREDIENTS
            // =========================
            var ingredientIndex = 0;
            var ingContainer = document.getElementById("ingredientRows");
            var btnAddIngredient = document.getElementById("btnAddIngredient");

            function addIngredientRow(name, qty, unit) {
                name = name || "";
                qty = qty || "";
                unit = unit || "";

                var row = document.createElement("div");
                row.className = "cr-ing-row";
                row.innerHTML =
                    '<div class="cr-ing-name">' +
                        '<input class="cr-small-input" name="Ingredients[' + ingredientIndex + '].IngredientName" placeholder="Ingredient name" value="' + name + '" />' +
                    '</div>' +
                    '<div class="cr-ing-qty">' +
                        '<input class="cr-small-input" type="number" step="0.1" name="Ingredients[' + ingredientIndex + '].Quantity" placeholder="Qty" value="' + qty + '" />' +
                    '</div>' +
                    '<div class="cr-ing-unit">' +
                        '<input class="cr-small-input" name="Ingredients[' + ingredientIndex + '].Unit" placeholder="Unit" value="' + unit + '" />' +
                    '</div>' +
                    '<button type="button" class="cr-remove-btn">✕</button>';

                ingContainer.appendChild(row);
                ingredientIndex++;
            }

            btnAddIngredient.addEventListener("click", function () {
                addIngredientRow();
            });

            ingContainer.addEventListener("click", function (e) {
                if (e.target.classList.contains("cr-remove-btn")) {
                    var row = e.target.closest(".cr-ing-row");
                    if (row) {
                        ingContainer.removeChild(row);
                    }
                }
            });

            // =========================
            // 3) DYNAMIC STEPS
            // =========================
            var stepIndex = 0;
            var stepContainer = document.getElementById("stepRows");
            var btnAddStep = document.getElementById("btnAddStep");

            function addStepRow(text) {
                text = text || "";

                var row = document.createElement("div");
                row.className = "cr-step-row";
                row.innerHTML =
                    '<div class="cr-step-text">' +
                        '<textarea class="cr-small-textarea" name="Steps[' + stepIndex + '].Description" placeholder="Describe the step...">' + text + '</textarea>' +
                    '</div>' +
                    '<button type="button" class="cr-remove-btn">✕</button>';

                stepContainer.appendChild(row);
                stepIndex++;
            }

            btnAddStep.addEventListener("click", function () {
                addStepRow();
            });

            stepContainer.addEventListener("click", function (e) {
                if (e.target.classList.contains("cr-remove-btn")) {
                    var row = e.target.closest(".cr-step-row");
                    if (row) {
                        stepContainer.removeChild(row);
                    }
                }
            });

            // Khởi tạo vài dòng trống ban đầu
            addIngredientRow();
            addIngredientRow();
            addIngredientRow();

            addStepRow();
            addStepRow();
            addStepRow();
        })();
    </script>
}
